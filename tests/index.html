<!DOCTYPE html>
<html>
  <head>
    <title>Tests | Thirteen</title>
    <link rel="stylesheet" href="../node_modules/mocha/mocha.css" />
  </head>
  <body>
    <div id="mocha"></div>
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sinon@latest/pkg/sinon.js"></script>
    <script type="module">
      import { MockLocalStorage, MockAmplitude } from "./mocks.js";
      import("https://cdn.jsdelivr.net/npm/chai@5.2.0/chai.min.js").then((chai) => {
        window.chai = chai;
        window.expect = chai.expect;

        mocha.setup("bdd");

        const storageSandbox = sinon.createSandbox();

        window.mochaHooks = {
          beforeEach() {
            const mockStorage = new MockLocalStorage();
            storageSandbox.stub(window.localStorage, "getItem").callsFake(mockStorage.getItem.bind(mockStorage));
            storageSandbox.stub(window.localStorage, "setItem").callsFake(mockStorage.setItem.bind(mockStorage));
            storageSandbox.stub(window.localStorage, "removeItem").callsFake(mockStorage.removeItem.bind(mockStorage));
            storageSandbox.stub(window.localStorage, "clear").callsFake(mockStorage.clear.bind(mockStorage));

            window.amplitude = new MockAmplitude();
          },
          afterEach() {
            storageSandbox.restore();
          },
        };

        const testFiles = [
          "./game/test_deck.js",
          "./game/test_game.js",
          "./game/test_client.js",
          "./game/test_rules.js",
          "./player/test_base.js",
          "./player/test_ai.js",
          "./player/test_human.js",
          "./player/test_factory.js",
          "./test_ui.js",
          "./ai/test_base.js",
          "./ai/test_combo.js",
          "./ai/test_highest_card.js",
          "./ai/test_highest_value.js",
          "./ai/test_lowest_card.js",
          "./ai/test_lowest_value.js",
          "./ai/test_pass.js",
          "./ai/test_personas.js",
          "./ai/test_prioritized_combo.js",
          "./ai/test_random_combo.js",
          "./ai/test_random.js",
          "./test_app.js",
          "./test_analytics.js",
        ];

        Promise.all(testFiles.map((file) => import(file))).then(() => {
          mocha.run();
        });
      });
    </script>
  </body>
</html>
